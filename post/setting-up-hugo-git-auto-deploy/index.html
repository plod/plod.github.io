<!DOCTYPE html>
<html lang="en-gb">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Setting up a hugo based website on ubuntu then auto deploy using gogs&#39; webhooks -- plod.tv</title>

    

    
    <link href="https://plod.tv//css/bootstrap.min.css" rel="stylesheet">

    
    <link href="https://plod.tv//css/clean-blog.min.css" rel="stylesheet">
    <link href="https://plod.tv//css/plod-custom.min.css" rel="stylesheet">

    
    <script src="https://use.fontawesome.com/2ab403e75d.js"></script>
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    

</head>

<body>
    
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://plod.tv/">plod.tv</a>
            </div>

                       
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    
                    <li>
                        <a href="https://plod.tv/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="https://plod.tv/contact/">Contact Me</a>
                    </li>
                    
                    <li>
                        <a href="https://plod.tv/post/">Archives</a>
                    </li>
                    
                  </ul>
            </div>
           

        </div>
        
    </nav>


    
    
    <header class="intro-header" style="background-image: url('https://plod.tv//img/bgs/deploy-bg.jpg')">
      
      <div class="container">
        <div class="row">
           <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
             <div class="post-heading">
               <h1>Setting up a hugo based website on ubuntu then auto deploy using gogs&#39; webhooks</h1>
               <h2 class="subheading"></h2>
               <span class="meta">
                 
Posted by <a href="#">Daniel T. Morgan</a> on Thursday Feb 18 2016
<br />
In 

<br />
Tags <a href="https://plod.tv/tags/go">go</a>, <a href="https://plod.tv/tags/golang">golang</a>, <a href="https://plod.tv/tags/hugo">hugo</a>, <a href="https://plod.tv/tags/digital-ocean">digital ocean</a>, <a href="https://plod.tv/tags/ubuntu">ubuntu</a>, <a href="https://plod.tv/tags/git">git</a>

               </span>
             </div>
           </div>
        </div>
      </div>
    </header>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  

<h2 id="what-is-hugo">What is Hugo?</h2>

<blockquote>
<p>Hugo is a static HTML and CSS website generator written in Go. It is optimized for speed, easy use and configurability. Hugo takes a directory with content and templates and renders them into a full HTML website.</p>

<p>Hugo relies on Markdown files with front matter for meta data. And you can run Hugo from any directory. This works well for shared hosts and other systems where you donâ€™t have a privileged account.</p>

<p>Hugo renders a typical website of moderate size in a fraction of a second. A good rule of thumb is that each piece of content renders in around 1 millisecond.</p>

<p>Hugo is designed to work well for any kind of website including blogs, tumbles and docs.</p>
</blockquote>

<p><a href="https://gohugo.io/">https://gohugo.io/</a></p>

<h2 id="what-is-gogs">What is Gogs?</h2>

<blockquote>
<p>The goal of this project is to make the easiest, fastest, and most painless way of setting up a self-hosted Git service. With Go, this can be done with an independent binary distribution across ALL platforms that Go supports, including Linux, Mac OS X, Windows and ARM.</p>
</blockquote>

<p><a href="https://gogs.io/">https://gogs.io/</a></p>

<p>It is a great self hosting github/gitlabs sort of project but coded in go.</p>

<hr />

<p>I started by following <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-hugo-a-static-site-generator-on-ubuntu-14-04">this digital ocean tutorial</a></p>

<p>I didn&rsquo;t want to use a package, my preference was to compile from <a href="https://gohugo.io/overview/installing/">source</a>. However I got the following error while trying that:
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"><span style="color:#080;font-weight:bold">go</span>: missing Mercurial command. See https:<span style="color:#888">//golang.org/s/gogetcmd
</span><span style="color:#888"></span><span style="color:#080;font-weight:bold">package</span> bitbucket.org<span style="color:#333">/</span>pkg<span style="color:#333">/</span>inflect: exec: <span style="background-color:#fff0f0">&#34;hg&#34;</span>: executable file not found in <span style="color:#f00;background-color:#faa">$</span>PATH</code></pre></div>
Thanks to <a href="http://kaiq.me/2015/12/23/go/go-get-tools/">this</a> and google translate I realised Mercurial was a dependancy.</p>

<p>so
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">sudo apt-get install mercurial</code></pre></div>
and then</p>

<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">go get -u -v github.com/spf13/hugo</code></pre></div>

<p>got me cooking!</p>

<p>In the DO tutorial it says to run</p>

<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">sudo hugo genautocomplete</code></pre></div>

<p>this seems to be factored out to</p>

<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">sudo hugo gen autocomplete</code></pre></div>

<p>but because I compiled from source hugo isn&rsquo;t in sudo environment path so</p>

<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">sudo ~/go-workspace/bin/hugo gen autocomplete</code></pre></div>

<p>[~/go-workspace is my $GOPATH so change to yours]</p>

<p>While cloning the themes I decided hugo-themes was a better name for the directory in my home dir (themes could be anything while browsing later), of course this meant later, my symlink would need to look like:</p>

<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console"> ln -s ../hugo-themes/ themes</code></pre></div>

<p>It seems that some other switches are different from the DO tutorial (-themes= in git cloned version is -t )</p>

<h1 id="auto-deploy">Auto deploy</h1>

<p>This is based on the digital ocean tutorial <a href="https://www.digitalocean.com/community/tutorials/how-to-deploy-a-hugo-site-to-production-with-git-hooks-on-ubuntu-14-04">here</a> the difference however was, is I use gogs, the server itself has no firewall access to my gogs server. I decided to solve this problem using the tutorial/gogs&rsquo; web hooks/and a little php (that I&rsquo;m sure I&rsquo;ll refactor as go at some stage)</p>

<p>First of all lets set up the gogs web hook:</p>

<p>Inside the repository in question click on the settings link on the right hand side</p>

<p><img src="https://plod.tv/img/post-img/gogs-settings.png" alt="Gogs Settings" /></p>

<p>Then click on the Webhooks link on the left hand side</p>

<p><img src="https://plod.tv/img/post-img/gogs-webhooks.png" alt="Gogs Webhooks" /></p>

<p>Finally enter a url the gogs server can connect to and that you can write php on (make a note of the Secret that you use)</p>

<p><img src="https://plod.tv/img/post-img/gogs-webhook.png" alt="Gogs Webhook" /></p>

<p>Now the php that runs at the URL you entered above should look a little something like this.</p>

<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#579">&lt;?php</span>
<span style="color:#888">//gogs secret for web hook
</span><span style="color:#888"></span><span style="color:#963">$secret</span>   <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;&#34;</span>;

<span style="color:#888">//keyword you are looking for in commit message to decide if to desploy
</span><span style="color:#888"></span><span style="color:#963">$deployCommitKeyword</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;[deploy] &#34;</span>;
<span style="color:#963">$json</span> <span style="color:#333">=</span> (<span style="color:#080;font-weight:bold">array</span>) json_decode(file_get_contents(<span style="background-color:#fff0f0">&#39;php://input&#39;</span>));

<span style="color:#080;font-weight:bold">if</span>(array_key_exists(<span style="background-color:#fff0f0">&#39;secret&#39;</span>, <span style="color:#963">$json</span>)<span style="color:#333">&amp;&amp;</span>(<span style="color:#963">$json</span>[<span style="background-color:#fff0f0">&#39;secret&#39;</span>]<span style="color:#333">==</span><span style="color:#963">$secret</span>)){
    <span style="color:#080;font-weight:bold">echo</span> <span style="background-color:#fff0f0">&#39;secret matched&#39;</span>;
    <span style="color:#080;font-weight:bold">if</span>(array_key_exists(<span style="background-color:#fff0f0">&#39;commits&#39;</span>, <span style="color:#963">$json</span>)){
        <span style="color:#080;font-weight:bold">for</span>(<span style="color:#963">$i</span><span style="color:#333">=</span><span style="color:#00d;font-weight:bold">0</span>, <span style="color:#963">$j</span><span style="color:#333">=</span>count(<span style="color:#963">$json</span>[<span style="background-color:#fff0f0">&#39;commits&#39;</span>]); <span style="color:#963">$i</span><span style="color:#333">&lt;</span><span style="color:#963">$j</span>; <span style="color:#963">$i</span><span style="color:#333">++</span>){
            <span style="color:#963">$json</span>[<span style="background-color:#fff0f0">&#39;commits&#39;</span>][<span style="color:#963">$i</span>] <span style="color:#333">=</span> (<span style="color:#080;font-weight:bold">array</span>) <span style="color:#963">$json</span>[<span style="background-color:#fff0f0">&#39;commits&#39;</span>][<span style="color:#963">$i</span>];
            <span style="color:#080;font-weight:bold">if</span>(array_key_exists(<span style="background-color:#fff0f0">&#39;message&#39;</span>, <span style="color:#963">$json</span>[<span style="background-color:#fff0f0">&#39;commits&#39;</span>][<span style="color:#963">$i</span>])<span style="color:#333">&amp;&amp;</span>(strstr(<span style="color:#963">$json</span>[<span style="background-color:#fff0f0">&#39;commits&#39;</span>][<span style="color:#963">$i</span>][<span style="background-color:#fff0f0">&#39;message&#39;</span>], <span style="color:#963">$deployCommitKeyword</span>))){
                do_deploy();
                <span style="color:#080;font-weight:bold">break</span>;
            }
    }
}

<span style="color:#080;font-weight:bold">function</span> <span style="color:#06b;font-weight:bold">do_deploy</span>(){
    <span style="color:#963">$GIT_REPO</span>           <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;</span><span style="background-color:#eee">$HOME</span><span style="background-color:#fff0f0">/my-website.git&#34;</span>;
    <span style="color:#963">$WORKING_DIRECTORY</span>  <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;</span><span style="background-color:#eee">$HOME</span><span style="background-color:#fff0f0">/my-website-working&#34;</span>;
    <span style="color:#963">$REMOTE_BACKUP_HTML</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;backup_html/&#34;</span>;
    <span style="color:#963">$REMOTE_PUBLIC_HTML</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;public_html/&#34;</span>;
    <span style="color:#963">$MY_SERVER_IP</span>       <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;server_domain_or_IP
</span><span style="background-color:#fff0f0">1&#34;</span>;
 
    <span style="color:#080;font-weight:bold">if</span>(<span style="color:#333">!</span>is_dir(<span style="color:#963">$WORKING_DIRECTORY</span>)){
        <span style="color:#963">$command</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;git clone </span><span style="background-color:#eee">$GIT_REPO</span><span style="background-color:#fff0f0"> </span><span style="background-color:#eee">$WORKING_DIRECTORY</span><span style="background-color:#fff0f0">&#34;</span>;
        <span style="color:#080;font-weight:bold">echo</span> <span style="background-color:#fff0f0">`$command`</span>;
    }<span style="color:#080;font-weight:bold">else</span>{
        <span style="color:#963">$command</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;cd </span><span style="background-color:#eee">$WORKING_DIRECTORY</span><span style="background-color:#fff0f0">; git pull&#34;</span>;
        <span style="color:#080;font-weight:bold">echo</span> <span style="background-color:#fff0f0">`$command`</span>;
    }
    <span style="color:#963">$command</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;cd </span><span style="background-color:#eee">$WORKING_DIRECTORY</span><span style="background-color:#fff0f0">; /path/to/hugo&#34;</span>;
    <span style="color:#080;font-weight:bold">echo</span> <span style="background-color:#fff0f0">`$command`</span>;
    <span style="color:#888">//lets rsync a copy of the working directory to backup
</span><span style="color:#888"></span>    <span style="color:#963">$command</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;ssh </span><span style="background-color:#eee">$MY_SERVER_IP</span><span style="background-color:#fff0f0"> rsync -r </span><span style="background-color:#eee">$REMOTE_PUBLIC_HTML</span><span style="background-color:#fff0f0"> </span><span style="background-color:#eee">$REMOTE_BACKUP_HTML</span><span style="background-color:#fff0f0">&#34;</span>;
    <span style="color:#080;font-weight:bold">echo</span> <span style="background-color:#fff0f0">`$command`</span>;
    <span style="color:#963">$command</span> <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;rsync -r </span><span style="background-color:#eee">$WORKING_DIRECTORY</span><span style="background-color:#fff0f0">/public/ </span><span style="background-color:#eee">$MY_SERVER_IP</span><span style="background-color:#fff0f0">:</span><span style="background-color:#eee">$REMOTE_PUBLIC_HTML</span><span style="background-color:#fff0f0">&#34;</span>;
    <span style="color:#080;font-weight:bold">echo</span> <span style="background-color:#fff0f0">`$command`</span>;
}
</code></pre></div>

<p><em>*update</em> I noticed that syntax hilighting was going missing on this post (turned out that pygmatize was not in path of the php process) (php runs as my user account) so I fixed this by changing</p>

<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$command = &#34;cd $WORKING_DIRECTORY; /path/to/hugo&#34;;
echo `$command`;</code></pre></div>

<p>to</p>

<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$command = &#34;cd $WORKING_DIRECTORY; export PATH=\&#34;What my $PATH is at tty\&#34; hugo&#34;;
echo `$command`;</code></pre></div>

<p>This felt a little dirty but after many attempts at a more elegent solution, I have stayed with this for the time being.</p>

                  

                </div>
            </div>
        </div>
    </article>

    <hr>
    
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <ul class="list-inline text-center">
                    
                      <li>
                        <a href="mailto:daniel@morgan.cymru">
                          <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                          </span>
                        </a>
                      </li>
                    
                    
                    
                    <li>
                      <a href="https://twitter.com/plodtv">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://github.com/plod">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://www.instagram.com/plodtv/">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://plus.google.com/&#43;DMo-plodtv">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://launchpad.net/~me-plod">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-linux fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="http://uk.linkedin.com/in/plodtv">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://www.freecodecamp.com/plod">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-free-code-camp fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    
                  </ul>
                  <p class="copyright text-muted"></p>
                </div>
            </div>
        </div>
    </footer>

    
    <script src="https://plod.tv//js/jquery.min.js"></script>

    
    <script src="https://plod.tv//js/bootstrap.min.js"></script>

    
    <script src="https://plod.tv//js/clean-blog.js"></script>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-21314793-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>

</html>

